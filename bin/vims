#!/bin/bash - 
#===============================================================================
#          FILE: vims.sh
#         USAGE: ./vims.sh SessionName
#   DESCRIPTION: See usage function
# 
#        AUTHOR: B. Leopold (cometsong), bleopoldNOSPAM@uni-muenster.de
#       COMPANY: Universitaetsklinik Muenster
#       CREATED: 2012-01-03 12:26:01+0100
#      REVISION: ---
#===============================================================================

#------------------------------------------------------------------------------#
#                               ... Variables ...                              #
#------------------------------------------------------------------------------#

VIM_SESSION_DIR=$HOME/.vimsessions
SESSION_NAME='default'
SESSION_FILE_EXT=vim
VIMINFO_FILE_EXT=viminfo

# Next line checks whether called by link named 'vims' or 'gvims', 'mvims', etc
VIMBINS=$(basename $0)
# strip 's' from end of link name
VIMBIN=${VIMBINS:0:${#VIMBINS}-1}

#echo Vimbins: $VIMBINS
#echo Vimbin: $VIMBIN

#------------------------------------------------------------------------------#
#                               ... Functions ...                              #
#------------------------------------------------------------------------------#
function usage () {
    echo "Usage":
    echo "  $0 SessionName"
    echo "This will load vim running a session by that name if the file exists."
    echo "If no file is found in the vimsessions directory ( $VIM_SESSION_DIR )"
    echo "then vim will create a new one. In both cases it will read or create"
    echo "a matching .viminfo file to read/store all Marks."
}

function SaveOnExit () {
        echo "au VimLeave * exe ' if strlen(v:this_session) | exe \"wviminfo! \" . v:this_session . \".viminfo\" | endif ' | 'if strlen(v:this_session) | exe \"mksession! \" . v:this_session | endif '"
}

function OpenSession () { 
    SAVE_SESSION=$(SaveOnExit)
    echo "Open: $SAVE_SESSION"
    $VIMBIN -c "source $VIM_SESSION_DIR/$SESSION_NAME.$SESSION_FILE_EXT 
        | rviminfo! $VIM_SESSION_DIR/$SESSION_NAME.$SESSION_FILE_EXT.$VIMINFO_FILE_EXT 
        | $SAVE_SESSION"
}

function CreateSession () { 
#    SAVE_SESSION=$(SaveOnExit)
#    echo "Create: $SAVE_SESSION"
    $VIMBIN -c "mksession! $VIM_SESSION_DIR/$SESSION_NAME.$SESSION_FILE_EXT 
        | wviminfo! $VIM_SESSION_DIR/$SESSION_NAME.$SESSION_FILE_EXT.$VIMINFO_FILE_EXT
        | au VimLeave * exe ' if strlen(v:this_session) | exe \"wviminfo! \" . v:this_session . \".viminfo\" | endif ' | 'if strlen(v:this_session) | exe \"mksession! \" . v:this_session | endif '"
}


#------------------------------------------------------------------------------#
#                                ... Main ...                                  #
#------------------------------------------------------------------------------#
if [[ ! -n $1 ]] || [[ $1 == "-h" ]]
then
    usage
    exit
else
    SESSION_NAME=$1
fi

if [[ -r $VIM_SESSION_DIR/$SESSION_NAME.$SESSION_FILE_EXT ]] ; then
   OpenSession  
else
    if [[ ! -d $VIM_SESSION_DIR ]] ; then
        mkdir -p $VIM_SESSION_DIR
    fi
    CreateSession
fi

